# Analysis File Creation {#sec-fcreate-zam}

```{r}
#| label: zam_analysis_file_creation_library
#| message: false
#| echo: fenced
#| warning: false
require(readxl)
require(readr)
require(Hmisc)
require(here)
require(data.table)
require(lubridate)
require(qs)
require(qreport)
```

## Raw data

Zambia submitted data to WHO at 23th, July, 2024.

16 files were submitted:

-   **DHIS2**

    -   HMIS data Lukwipa and Kankumba.xls

    -   Weekly data.xlsx

-   **Surveys**

    -   1,7_experiment_data_status.xlsx

    -   Baseline and Endline Survey- Codebook.xlsx

    -   **Baseline**

        -   census_phone_combine.csv

        -   household_member_phone_combine.csv

        -   household_phone_combine.csv

        -   net_phone_combine.csv

        -   Rufunsa 1,7mRCT BASE-LINE MICROSCOPY RESULTS final.xlsx

        -   visit_phone_combine.csv

    -   **Endline**

        -   1,7 Parasite Microscope endline survey 2023 results_updated Rufunsa_version.xlsx

        -   Endline household_member_all.csv

        -   Endline-census.xls

        -   Endline-household.xls

        -   Endline-net.xls

        -   Endline-visit.xls

### Data Pathes

```{r}
source(here("R/paths.R"))
```

### Load Data

```{r}
#| label: zam_load_raw_data
#| warning: false
#| message: false

# DHIS2
zam_dh_hf_raw <- read_excel(
  here(PATH_ZAM_DH_HF_RAW_240723),
  skip = 1,
  col_types = c("text",
                "text",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric"
                )
  )
zam_dh_vl_raw <- read_excel(here(PATH_ZAM_DH_VL_RAW_240723) , skip = 2)
zam_dh_vl_pop <- read_excel(here(PATH_ZAM_DH_VL_POP_240908))
zam_dh_vl_raw <- read_excel(here(PATH_ZAM_DH_VL_PROCESSED_240908))
# Survey
zam_hh_hh_raw <- read_excel(here(PATH_ZAM_HH_HH_RAW_240723))
zam_hh_codebook_raw <- read_excel(here(PATH_ZAM_HH_CODEBOOK_RAW_240723))

## Baseline
zam_hhb_hh_houseinfo_raw <- fread(here(PATH_ZAM_HHB_HH_HOUSEINFO_RAW_240723))
zam_hhb_pr_raw <- fread(here(PATH_ZAM_HHB_PR_RAW_240723))
zam_hhb_hh_detailed_houseinfo_raw <- fread(here(PATH_ZAM_HHB_HH_DETAILED_HOUSEINFO_RAW_240723))
zam_hhb_hh_itn_raw <- fread(here(PATH_ZAM_HHB_HH_ITN_RAW_240723))
zam_hhb_hh_test_raw <- read_excel(here(PATH_ZAM_HHB_HH_TEST_RAW_240723))
zam_hhb_hh_visit_raw <- fread(here(PATH_ZAM_HHB_HH_VISIT_RAW_240723))

## Endline
zam_hhe_hh_houseinfo_raw <- read_excel(here(PATH_ZAM_HHE_HH_HOUSEINFO_RAW_240723))
zam_hhe_pr_raw <- fread(here(PATH_ZAM_HHE_PR_RAW_240723))
zam_hhe_hh_detailed_houseinfo_raw <- read_excel(here(PATH_ZAM_HHE_HH_DETAILED_HOUSEINFO_RAW_240723))
zam_hhe_hh_itn_raw <- read_excel(here(PATH_ZAM_HHE_HH_ITN_RAW_240723))
zam_hhe_hh_test_raw <- read_excel(here(PATH_ZAM_HHE_HH_TEST_RAW_240723))
zam_hhe_hh_visit_raw <- read_excel(here(PATH_ZAM_HHE_HH_VISIT_RAW_240723))
```

## DHIS2 data

### Monthly HFCA Malaria

```{r}
#| label: zam-updata-dh-hf
#| lst-label: zam-updata-dh-hf
#| lst-cap: Recode HFCA data from DHIS2, Zambia
zam_dh_hf <- upData(
  zam_dh_hf_raw,
  YEAR = my(periodname) |> year(),
  MONTH = my(periodname) |> month(),
  rename = .q(organisationunitname = HFCA,
              "Malaria Clinical Cases" = MC_CLN,
              "Malaria Confirmed Cases" = MC_CFM,
              "Malaria in Pregnancy Clinical Cases" = MPC_CLN,
              "Malaria in Pregnancy Confirmed Cases" = MPC_CFM,
              "Malaria Incidence Clinical+Confirmed all ages" = MI,
              "Malaria incidence _Confirmed rate all ages" = MI_CFM,
              "Malaria death 5 years and older - total" = MD_OV5,
              "Malaria death under 5 years - total" = MD_U5,
              "Malaria case confirmation rate (%)" = MC_CFR
              ),
  labels = c(
    HFCA = "Health facility catchment area",
    MC_CLN = "Reported clinical diagnosed malaria cases in the HFCA",
    MC_CFM = "Reported confirmed malaria cases in the HFCA",
    MPC_CLN = "Reported clinical diagnosed malaria cases in pregnant women in the HFCA",
    MPC_CFM = "Reported confirmed malaria cases in pregnant women in the HFCA",
    MI = "Malaria incidence in the HFCA, clinical+confirmed cases, all ages",
    MI_CFM = "Malaria incidence in the HFCA, confirmed cases, all ages",
    MD_OV5 = "Malaria death in the HFCA, 5 years and older",
    MD_U5 = "Malaria death in the HFCA, under 5 years",
    MC_CFR = "Malaria case confirmation rate"
  ),
  units = .q(
    YEAR = years,
    MONTH = months,
    MC_CLN = cases,
    MC_CFM = cases,
    MPC_CLN = cases,
    MPC_CFM = cases,
    MI = "cases per 1000 people",
    MI_CFM = "cases per 1000 people",
    MD_OV5 = deaths,
    MD_U5 = deaths,
    MC_CFR = percent
  ),
  drop = .q(
    periodname
  ),
  HFCA = as.factor(HFCA)
) |> data.table::as.data.table()

qsave(zam_dh_hf, here(PATH_ZAM_DH_HF))

contents(zam_dh_hf)
```

see @sec-meta-data-date, @sec-meta-data-administrative, @sec-meta-data-malaria for more information.

### Weekly Village Level Malaria

```{r}
#| label: zam-updata-dh-vl
#| lst-label: zam-updata-dh-vl
#| lst-cap: Recode Village level weekly data from DHIS2, Zambia



```

### Village Population Table

```{r}
zam_dh_vl_pop <- upData(
  zam_dh_vl_raw,
  rename = c(
    VILLAGE = `Village Name`,
    POP = `Population`
  ),
  labels = c(
    VILLAGE = "Village name",
    POP = "Village population"
  ),
  units = c(
    POP = "people"
  ),
  VILLAGE = as.factor(VILLAGE)
)

# Remove duplicates and keep only unique village-population pairs
zam_dh_vl_pop <- unique(zam_dh_vl_pop[, c("VILLAGE", "POP")])
```
