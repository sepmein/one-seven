# Analysis File Creation {#sec-fcreate-zam}

```{r}
#| label: zam_analysis_file_creation_library
#| message: false
#| echo: fenced
#| warning: false
require(readxl)
require(readr)
require(Hmisc)
require(here)
require(data.table)
require(lubridate)
require(qs)
require(qreport)
```

## Raw data

Zambia submitted data to WHO at 23th, July, 2024.

16 files were submitted:

-   **DHIS2**

    -   HMIS data Lukwipa and Kankumba.xls

    -   Weekly data.xlsx

-   **Surveys**

    -   1,7_experiment_data_status.xlsx

    -   Baseline and Endline Survey- Codebook.xlsx

    -   **Baseline**

        -   census_phone_combine.csv

        -   household_member_phone_combine.csv

        -   household_phone_combine.csv

        -   net_phone_combine.csv

        -   Rufunsa 1,7mRCT BASE-LINE MICROSCOPY RESULTS final.xlsx

        -   visit_phone_combine.csv

    -   **Endline**

        -   1,7 Parasite Microscope endline survey 2023 results_updated Rufunsa_version.xlsx

        -   Endline household_member_all.csv

        -   Endline-census.xls

        -   Endline-household.xls

        -   Endline-net.xls

        -   Endline-visit.xls

### Data Pathes

```{r}
source(here("R/paths.R"))
```

### Load Data

```{r}
#| label: zam_load_raw_data
#| warning: false
#| message: false

# DHIS2
zam_dh_hf_raw <- read_excel(
  here(PATH_ZAM_DH_HF_RAW_240723),
  skip = 1,
  col_types = c("text",
                "text",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric",
                "numeric"
                )
  )
zam_dh_vl_raw <- read_excel(here(PATH_ZAM_DH_VL_RAW_240723) , skip = 2)
zam_dh_vl_pop <- read_excel(here(PATH_ZAM_DH_VL_POP_240908))
zam_dh_vl_raw <- read_excel(here(PATH_ZAM_DH_VL_PROCESSED_240908))
# Survey
zam_hh_hh_raw <- read_excel(here(PATH_ZAM_HH_HH_RAW_240723))
zam_hh_codebook_raw <- read_excel(here(PATH_ZAM_HH_CODEBOOK_RAW_240723))

## Baseline
zam_hhb_hh_houseinfo_raw <- fread(here(PATH_ZAM_HHB_HH_HOUSEINFO_RAW_240723))
zam_hhb_pr_raw <- fread(here(PATH_ZAM_HHB_PR_RAW_240723))
zam_hhb_hh_detailed_houseinfo_raw <- fread(here(PATH_ZAM_HHB_HH_DETAILED_HOUSEINFO_RAW_240723))
zam_hhb_hh_itn_raw <- fread(here(PATH_ZAM_HHB_HH_ITN_RAW_240723))
zam_hhb_hh_test_raw <- read_excel(here(PATH_ZAM_HHB_HH_TEST_RAW_240723))
zam_hhb_hh_visit_raw <- fread(here(PATH_ZAM_HHB_HH_VISIT_RAW_240723))

## Endline
zam_hhe_hh_houseinfo_raw <- read_excel(here(PATH_ZAM_HHE_HH_HOUSEINFO_RAW_240723))
zam_hhe_pr_raw <- fread(here(PATH_ZAM_HHE_PR_RAW_240723))
zam_hhe_hh_detailed_houseinfo_raw <- read_excel(here(PATH_ZAM_HHE_HH_DETAILED_HOUSEINFO_RAW_240723))
zam_hhe_hh_itn_raw <- read_excel(here(PATH_ZAM_HHE_HH_ITN_RAW_240723))
zam_hhe_hh_test_raw <- read_excel(here(PATH_ZAM_HHE_HH_TEST_RAW_240723))
zam_hhe_hh_visit_raw <- read_excel(here(PATH_ZAM_HHE_HH_VISIT_RAW_240723))
```

## DHIS2 data

### Monthly HFCA Malaria

```{r}
#| label: zam-updata-dh-hf
#| lst-label: zam-updata-dh-hf
#| lst-cap: Recode HFCA data from DHIS2, Zambia
zam_dh_hf <- upData(
  zam_dh_hf_raw,
  YEAR = my(periodname) |> year(),
  MONTH = my(periodname) |> month(),
  rename = .q(organisationunitname = HFCA,
              "Malaria Clinical Cases" = MC_CLN,
              "Malaria Confirmed Cases" = MC_CFM,
              "Malaria in Pregnancy Clinical Cases" = MPC_CLN,
              "Malaria in Pregnancy Confirmed Cases" = MPC_CFM,
              "Malaria Incidence Clinical+Confirmed all ages" = MI,
              "Malaria incidence _Confirmed rate all ages" = MI_CFM,
              "Malaria death 5 years and older - total" = MD_OV5,
              "Malaria death under 5 years - total" = MD_U5,
              "Malaria case confirmation rate (%)" = MC_CFR
              ),
  labels = c(
    HFCA = "Health facility catchment area",
    MC_CLN = "Reported clinical diagnosed malaria cases in the HFCA",
    MC_CFM = "Reported confirmed malaria cases in the HFCA",
    MPC_CLN = "Reported clinical diagnosed malaria cases in pregnant women in the HFCA",
    MPC_CFM = "Reported confirmed malaria cases in pregnant women in the HFCA",
    MI = "Malaria incidence in the HFCA, clinical+confirmed cases, all ages",
    MI_CFM = "Malaria incidence in the HFCA, confirmed cases, all ages",
    MD_OV5 = "Malaria death in the HFCA, 5 years and older",
    MD_U5 = "Malaria death in the HFCA, under 5 years",
    MC_CFR = "Malaria case confirmation rate"
  ),
  units = .q(
    YEAR = years,
    MONTH = months,
    MC_CLN = cases,
    MC_CFM = cases,
    MPC_CLN = cases,
    MPC_CFM = cases,
    MI = "cases per 1000 people",
    MI_CFM = "cases per 1000 people",
    MD_OV5 = deaths,
    MD_U5 = deaths,
    MC_CFR = percent
  ),
  drop = .q(
    periodname
  ),
  HFCA = as.factor(HFCA)
) |> data.table::as.data.table()

qsave(zam_dh_hf, here(PATH_ZAM_DH_HF))

contents(zam_dh_hf)
```

see @sec-meta-data-date, @sec-meta-data-administrative, @sec-meta-data-malaria for more information.


### Village Population Table

```{r}
#| label: zam-updata-dh-vl-pop
#| lst-label: zam-updata-dh-vl-pop
#| lst-cap: Recode Village population table from DHIS2, Zambia
zam_dh_vl_pop <- upData(
  zam_dh_vl_pop,
  labels = c(
    VILLAGE = "Village name",
    POPULATION = "Village population"
  ),
  units = c(
    POPULATION = "people"
  ),
  VILLAGE = as.factor(VILLAGE)
)

qsave(zam_dh_vl_pop, here(PATH_ZAM_DH_VL_POP))
```

### Weekly Village Level Malaria

The village level data is reported by the health facilities. The raw data provided is aggregated by week and village.
The raw data was organized:

```{r}
zam_dh_vl_raw <- zam_dh_vl_raw |> as.data.table()
```


```{r}
#| label: zam-updata-dh-vl
#| lst-label: zam-updata-dh-vl
#| lst-cap: Recode Village level weekly data from DHIS2, Zambia

# pivot longer based on DATE and VARIABLE columns, the other columns use names as VILLAGE
# data.table::dcast function was used to pivot the data

zam_dh_vl <- data.table::melt(zam_dh_vl_raw, 
                              id.vars = c("DATE", "VARIABLE"), 
                              variable.name = "VILLAGE",
                              value.name = "VALUE"
)

zam_dh_vl <- zam_dh_vl[
  , .(
    DATE = as.Date(sapply(DATE, function(x) {
      # Function to convert "19-25 Dec" to a date
      convert_to_date <- function(date_str) {
        # Extract year from the current system date
        current_year <- format(Sys.Date(), "%Y")
        
        # Split the date range
        date_parts <- strsplit(date_str, " ")[[1]]
        
        # Extract the end day and month
        end_day <- strsplit(date_parts[1], "-")[[1]][2]
        month <- date_parts[2]
        
        # Create the date string
        date_string <- paste(end_day, month, current_year)
        
        # Convert to Date object
        as.Date(date_string, format = "%d %b %Y")
      }
      
      convert_to_date(x)
    })),
    VARIABLE = as.factor(VARIABLE),
    VILLAGE = as.factor(VILLAGE),
    VALUE = as.numeric(VALUE)
  )

] |> upData(
  labels = c(
    DATE = "Date",
    VARIABLE = "two variables: tested and positive cases",
    VILLAGE = "Village",
    VALUE = "The value of the variable"
  ),
  units = c(
    DATE = "Date",
    VILLAGE = "Village",
    VALUE = "cases"
  )
)

qsave(zam_dh_vl, here(PATH_ZAM_DH_VL))

```

